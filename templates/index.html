
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AWS Cost Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <!-- Estilos propios -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">AWS Cost Report</h2>

    <!-- =========================
         FORMULARIO DE SUBIDA (2 FICHEROS)
         ========================= -->
    {% if not table_data %}
    <form method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="file_graph" class="form-label">
          Fichero 1 – Detalle (para gráficos/comparativas)
        </label>
        <input type="file" class="form-control" id="file_graph" name="file_graph" accept=".csv" required>
        <div class="form-text">
          Debe incluir columnas como <em>Usage Start Date, Account, Usage Amount, Tax, Edp Discount, Service…</em>
        </div>
      </div>

      <div class="mb-3">
        <label for="file_table" class="form-label">
          Fichero 2 – Resumen (para tabla de totales)
        </label>
        <input type="file" class="form-control" id="file_table" name="file_table" accept=".csv" required>
        <div class="form-text">
          Debe contener al menos: <strong>Account</strong>, <strong>Month</strong>, <strong>Usage</strong>,
          <strong>Tax</strong>, <strong>Edp Discount</strong>, <strong>PCS Enabler Cost</strong>,
          <strong>Operations &amp; Security</strong>, <strong>Account Enablement Fee</strong>, <strong>Total Cost</strong>.
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Procesar</button>
    </form>
    {% endif %}

    <!-- =========================
         TABLA PRINCIPAL (CSV RESUMEN)
         ========================= -->
    {% if table_data %}
    <div id="results" class="mt-4">
      <h5>Total cost (€) por AWS account – Agregado multi‑mes</h5>
      {% if periodo %}
      <p class="text-muted">Period: {{ periodo }}</p>
      {% endif %}

      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th class="text-start">Account</th>
              <th class="text-end">Usage €</th>
              <th class="text-end">Tax €</th>
              <th class="text-end">Edp Discount €</th>
              <th class="text-end">PCS Enabler Cost €</th>
              <th class="text-end">Operations &amp; Security €</th>
              <th class="text-end">Account Enablement Fee €</th>
              <th class="text-end">Total Cost €</th>
            </tr>
          </thead>
          <tbody>
            {% for row in table_data %}
            <tr>
              <td class="text-start">{{ row["Account"] }}</td>
              <td class="text-end">{{ "%.2f"|format(row["Usage"]) }}</td>
              <td class="text-end">{{ "%.2f"|format(row["Tax"]) }}</td>
              <td class="text-end">{{ "%.2f"|format(row["Edp Discount"]) }}</td>
              <td class="text-end">{{ "%.2f"|format(row["PCS Enabler Cost"]) }}</td>
              <td class="text-end">{{ "%.2f"|format(row["Operations & Security"]) }}</td>
              <td class="text-end">{{ "%.2f"|format(row["Account Enablement Fee"]) }}</td>
              <td class="text-end">{{ "%.2f"|format(row["Total Cost"]) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- =========================
         SECCIÓN PRESUPUESTO (usa Fichero 1 - detalle)
         ========================= -->
    <div class="mt-5 d-flex justify-content-center">
      <div class="p-4 border rounded bg-white shadow-sm" style="max-width: 700px; width: 100%;">
        <h5 style="cursor: pointer;" onclick="toggleBudgetSection()" class="d-flex justify-content-between align-items-center">
          Budget expenditure for current fiscal year
          <span id="arrowToggle" style="font-size: 1.2em;">▼</span>
        </h5>

        <div id="budgetSection" style="display: none;" class="mt-3">
          <div class="row align-items-end g-2">
            <div class="col-md-8">
              <label for="fiscalBudget" class="form-label">Budget allocated (€):</label>
              <input type="number" class="form-control" id="fiscalBudget" placeholder="Enter amount in euros">
            </div>
            <div class="col-md-4">
              <button id="calculateBudgetBtn" class="btn btn-success w-100" disabled>Calculate</button>
            </div>
          </div>

          <div id="budgetResult" class="mt-4" style="display: none;">
            <p>Total spent: <strong id="spentAmount">0 €</strong></p>
            <div class="progress">
              <div id="budgetProgress" class="progress-bar" role="progressbar"
                   style="width: 0%;" aria-valuemin="0" aria-valuemax="100">
                0%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
         COMPARATIVA ENTRE MESES (usa Fichero 1 - detalle)
         ========================= -->
    {% if months %}
    <div class="mt-5" style="max-width: 900px; margin: 0 auto;">
      <h5 class="text-center">Comparison between different months period</h5>

      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-5">
          <label for="currentMonth">Current Month</label>
          <select id="currentMonth" class="form-select">
            {% for m in months %}
            <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-5">
          <label for="compareMonth">Compared to Month</label>
          <select id="compareMonth" class="form-select">
            {% for m in months %}
            <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-2">
          <button onclick="compareMonths()" class="btn btn-primary w-100">Compare</button>
        </div>
      </div>

      <div id="comparisonResults" class="mt-4" style="display: none;">
        <h5>Results:</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th class="text-start">AWS Account</th>
                <th class="text-start">Difference (€)</th>
                <th class="text-start">Variation (%)</th>
              </tr>
            </thead>
            <tbody id="comparisonTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- =========================
         GRÁFICO APILADO GLOBAL (usa Fichero 1 - detalle)
         ========================= -->
    {% if graphJSON %}
    <div class="mt-5 d-flex justify-content-center">
      <div style="width: 80%;">
        <h5 class="text-center">Monthly cost per AWS account</h5>
        <div id="stackedBarChart"></div>
      </div>
    </div>
    {% endif %}

    <!-- =========================
         SELECCIÓN Y GRÁFICOS POR CUENTA (usa Fichero 1 - detalle)
         ========================= -->
    {% if accounts %}
    <div class="mt-5">
      <h5 class="text-center">Cost breakdown per service</h5>
      <div class="row justify-content-center">
        <div class="col-md-6">
          <label for="accountSelector">Select the AWS account:</label>
          <select id="accountSelector" class="form-select">
            {% for acc in accounts %}
            <option value="{{ acc }}">{{ acc }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="mt-4" id="accountChartContainer" style="width: 80%; margin: auto;"></div>
    </div>

    <!-- Donut -->
    <div class="mt-5 d-flex justify-content-center" id="donutContainer" style="display: none;">
      <div style="width: 80%;">
        <h5 class="text-center">Service Cost Distribution (Latest Month)</h5>
        <div id="donutChartContainer"></div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Variables JS desde servidor -->
  {% if graphJSON %}
  <script>
    const stackedBar = {{ graphJSON | safe }};
  </script>
  {% endif %}

  <!-- JS propio -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>

  <!-- Render del stacked si existe -->
  <script>
    if (typeof stackedBar !== "undefined") {
      Plotly.newPlot("stackedBarChart", stackedBar.data, stackedBar.layout, { responsive: true });
    }
  </script>
</body>
</html>
